{
	"$schema": "http://json-schema.org/draft-07/schema#",
	"$id": "task.schema",
	"title": "Task Schema",
	"description": "Schema for task YAML files used by BMAD agents",
	"type": "object",
	"required": ["id", "title", "version", "purpose", "process"],
	"additionalProperties": false,
	"properties": {
		"$schema": {
			"type": "string",
			"description": "Reference to this schema file (for validation)",
			"const": "../../.internal/task.schema.json"
		},
		"id": {
			"type": "string",
			"description": "Unique identifier for the task. Can be inferred from filename",
			"pattern": "^[a-z0-9-]+$",
			"examples": ["develop-story", "review-story", "create-doc"]
		},
		"title": {
			"type": "string",
			"description": "Human-readable title of the task",
			"minLength": 1,
			"maxLength": 200
		},
		"version": {
			"type": "string",
			"description": "Semantic version of the task",
			"pattern": "^\\d+\\.\\d+\\.\\d+$",
			"examples": ["1.0.0", "2.1.3"]
		},
		"purpose": {
			"type": "string",
			"description": "Brief description of what this task accomplishes"
		},
		"category": {
			"type": "string",
			"description": "Category of the task",
			"enum": [
				"development",
				"quality",
				"documentation",
				"planning",
				"deployment",
				"maintenance",
				"other"
			]
		},
		"agent": {
			"type": "string",
			"description": "Primary agent responsible for this task",
			"enum": ["dev", "qa", "pdm", "any"],
			"default": "any"
		},
		"derived": {
			"type": "array",
			"description": "Inputs derived from other source(s)",
			"items": {
				"type": "object",
				"required": ["name", "type", "source"],
				"properties": {
					"name": {
						"type": "string",
						"pattern": "^[a-z_][a-z0-9_]*$"
					},
					"description": {
						"type": "string"
					},
					"type": {
						"type": "string",
						"enum": [
							"string",
							"number",
							"boolean",
							"array",
							"object",
							"path",
							"epic_id",
							"story_id",
							"command"
						]
					},
					"pattern": {
						"type": "string",
						"description": "Regex pattern for path matching and validation"
					},
					"source": {
						"type": "string",
						"description": "Source of the input parameter",
						"enum": ["context", "file", "parameters"]
					},
					"location": {
						"type": "string",
						"description": "Exact location of a file or folder where needed docs and resources can be found to supply to this input if source is file"
					},
					"default": {
						"description": "Default value if not provided"
					},
					"required": {
						"type": "boolean",
						"description": "Whether this input is required for the task to execute"
					}
				}
			}
		},
		"outputs": {
			"type": "object",
			"description": "Output artifacts and results",
			"properties": {
				"artifacts": {
					"type": "array",
					"description": "Files or resources produced",
					"items": {
						"type": "object",
						"required": ["name", "type", "path"],
						"properties": {
							"name": {
								"type": "string"
							},
							"type": {
								"type": "string",
								"enum": [
									"file",
									"directory",
									"report",
									"gate",
									"assessment"
								]
							},
							"path": {
								"type": "string",
								"description": "Path pattern where artifact is created"
							},
							"format": {
								"type": "string",
								"enum": [
									"yaml",
									"json",
									"markdown",
									"html",
									"text",
									"binary"
								]
							},
							"description": {
								"type": "string"
							}
						}
					}
				},
				"updates": {
					"type": "array",
					"description": "Files or sections updated",
					"items": {
						"type": "object",
						"required": ["target", "sections"],
						"properties": {
							"target": {
								"type": "string",
								"description": "File path pattern to update"
							},
							"sections": {
								"type": "array",
								"description": "Sections within the file that can be updated",
								"items": {
									"type": "string"
								}
							},
							"restrictions": {
								"type": "string",
								"description": "Any restrictions on updates"
							}
						}
					}
				}
			}
		},
		"prerequisites": {
			"type": "array",
			"description": "Conditions that must be met before task execution",
			"items": {
				"type": "object",
				"required": ["field", "value", "operator", "on_violate"],
				"properties": {
					"field": {
						"type": "string",
						"description": "The field to evaluate. Can be a reference to a variable or a property of the task"
					},
					"value": {
						"type": "string",
						"description": "The value to compare against"
					},
					"operator": {
						"type": "string",
						"enum": [
							"=",
							"!=",
							"<",
							">",
							"<=",
							">=",
							"contains",
							"in",
							"not_in"
						],
						"default": "="
					},
					"on_violate": {
						"type": "string",
						"enum": ["halt_and_report", "continue_with_warning"]
					}
				}
			}
		},
		"steps": {
			"type": "array",
			"description": "Process steps to execute",
			"minItems": 1,
			"items": {
				"type": "object",
				"required": ["id", "title", "description", "action"],
				"properties": {
					"id": {
						"type": "string",
						"pattern": "^[A-Z]+$"
					},
					"title": {
						"type": "string"
					},
					"description": {
						"type": "string"
					},
					"conditions": {
						"type": "array",
						"description": "Conditions for moving between steps execution",
						"items": {
							"type": "object",
							"properties": {
								"move_to_step": {
									"type": "string",
									"description": "Step to execute if condition is met"
								},
								"when": {
									"type": "string",
									"description": "Condition to evaluate"
								}
							}
						}
					},
					"action": {
						"type": "object",
						"description": "Action to perform",
						"properties": {
							"type": {
								"type": "string",
								"enum": [
									"command",
									"file_operation",
									"validation",
									"decision",
									"subtask",
									"elicit",
									"analysis"
								]
							},
							"command": {
								"type": "string",
								"description": "Command to execute (if type is command)"
							},
							"operation": {
								"type": "string",
								"description": "File operation (if type is file_operation)",
								"enum": [
									"create",
									"update",
									"delete",
									"copy",
									"move",
									"read"
								]
							},
							"target": {
								"type": "string",
								"description": "Target file or resource"
							},
							"template": {
								"type": "string",
								"description": "Template to use to fill out content of some file/report"
							},
							"prompt_user": {
								"type": "string",
								"description": "Prompt for user elicitation"
							},
							"options": {
								"type": "array",
								"description": "Options for user selection",
								"items": {
									"type": "string"
								}
							},
							"validation": {
								"type": "object",
								"description": "Validation rules",
								"properties": {
									"type": {
										"type": "string"
									},
									"pattern": {
										"type": "string"
									},
									"required": {
										"type": "boolean"
									}
								}
							}
						}
					},
					"retry": {
						"type": "object",
						"description": "Retry configuration",
						"properties": {
							"max_attempts": {
								"type": "number",
								"minimum": 1,
								"maximum": 10
							},
							"delay_seconds": {
								"type": "number",
								"minimum": 0
							}
						}
					},
					"on_failure": {
						"type": "string",
						"description": "Action on failure",
						"enum": ["halt", "continue", "skip", "rollback"]
					},
					"on_success": {
						"type": "string",
						"description": "Action on success",
						"enum": ["halt", "continue", "skip", "rollback"]
					},
					"elicit": {
						"type": "boolean",
						"description": "Whether this step requires user interaction",
						"default": false
					}
				}
			}
		},
		"completion": {
			"type": "object",
			"description": "Completion criteria",
			"properties": {
				"checklist": {
					"type": "string",
					"description": "Reference to completion checklist"
				},
				"criteria": {
					"type": "array",
					"description": "Explicit completion criteria",
					"items": {
						"type": "string"
					}
				},
				"validations": {
					"type": "array",
					"description": "Validation commands to run",
					"items": {
						"type": "object",
						"properties": {
							"command": {
								"type": "string"
							},
							"expected_output": {
								"type": "string"
							}
						}
					}
				}
			}
		}
	}
}
