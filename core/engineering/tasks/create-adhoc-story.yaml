$schema: ../../.internal/task.schema.json
id: create-adhoc-story
title: Create Enhancement Story from Enhancement Epic
purpose: Create one story for the highest-order enhancement epic, referencing its epic YAML and PRD/Architecture docs. Output YAML strictly follows the story schema.
category: planning
agent: pdm

derived:
  - name: epic_enhancement_number_resolved
    type: number
    source: parameters
    description: "Enhancement epic number (uses ${enhancement_epic}; auto-detects highest adhoc epic when not provided)."
    required: true
  - name: story_enhancement_number_resolved
    type: number
    source: context
    description: "Story enhancement number (uses ${story_enhancement_number} or next sequential adhoc story)."
    required: true
  - name: epic_file_path
    type: path
    source: context
    pattern: "@{docs.subdirs.epics}/adhoc-{epic_enhancement_number_resolved}-*.yaml"
    required: true
  - name: story_file_target
    type: path
    source: context
    pattern: "@{docs.subdirs.stories}/adhoc-{epic_enhancement_number_resolved}.{story_enhancement_number_resolved}-*.yaml"
    required: true
  - name: previous_story_file
    type: path
    source: context
    description: "Highest existing adhoc story file for the enhancement."
    required: false
  - name: impact_assessment
    type: string
    source: context
    pattern: "^[1-4]$"
    description: "Response captured during Assess Document Impact (1-4)."

outputs:
  artifacts:
    - name: Story File
      type: file
      path: "!{story_file_target}"
      format: yaml
    - name: Documentation Updates
      type: file
      path: "@{docs.dir}/"
      format: markdown
  updates:
    - target: "!{story_file_target}"
      sections:
        - "Dev Notes"
        - "Tasks / Subtasks"
      restrictions: Only create a new story; do not modify existing stories

prerequisites:
  - field: "@{docs.subdirs.epics}"
    value: "readable"
    operator: "="
    on_violate: "halt_and_report"
  - field: "@{docs.subdirs.stories}"
    value: "writable"
    operator: "="
    on_violate: "halt_and_report"

steps:
  - id: CONFIG-1
    title: Load Core Configuration
    description: Load config.json and verify docs paths needed for adhoc enhancement work
    action:
      type: file_operation
      operation: read
      target: "@{baseDir}/config.json"
    on_failure: halt

  - id: IDENTIFY-EPIC
    title: Locate Highest Enhancement Epic
    description: Determine the target enhancement epic number and file
    action:
      type: analysis
      instruction: |
        Scan @{docs.subdirs.epics} for files named adhoc-*.yaml.
        - If ${enhancement_epic} is provided, set !{epic_enhancement_number_resolved} to that value.
        - Otherwise choose the maximum enhancement number and set !{epic_enhancement_number_resolved} accordingly.
        Resolve !{epic_file_path} for downstream steps.

  - id: IDENTIFY-STORY
    title: Determine Next Story Number
    description: Select the next adhoc story number within the enhancement
    action:
      type: analysis
      instruction: |
        Scan @{docs.subdirs.stories} for adhoc-!{epic_enhancement_number_resolved}.*-*.yaml.
        - Compute the next sequential story number (start at 1 if none exist).
        - If ${story_enhancement_number} is provided, honor it instead.
        - Record !{previous_story_file} and resolve !{story_file_target}.

  - id: READ-EPIC
    title: Read Epic YAML
    description: Extract story-level requirements from the enhancement epic
    action:
      type: file_operation
      operation: read
      target: "!{epic_file_path}"
      instruction: |
        Extract from story-breakdown:
        - Candidate titles/goals
        - Acceptance criteria references and priorities
        - Dependencies

  - id: READ-DOCS
    title: Read PRD and Architecture for Enhancement
    description: Collect supporting context from PRD and architecture docs
    action:
      type: file_operation
      operation: read
      target: "@{docs.files.prd}"
      instruction: |
        Load @{docs.files.prd} plus relevant architecture documents (@{docs.dir}/?(*-)architecture.md) before extracting technical details for the story.

  - id: EXTRACT-TECH
    title: Extract Technical Details for Story
    description: Capture only doc-sourced technical context to guide implementation
    action:
      type: analysis
      instruction: |
        Extract strictly from PRD/architecture (never invent):
        - Data models or schemas relevant to the story
        - API endpoints and contracts
        - Component specifications (UI)
        - File paths and naming conventions
        - Testing requirements
        - Security/performance considerations
        Cite doc references for every extracted detail.

  - id: CREATE-STORY
    title: Create Story YAML (schema-aligned)
    description: Create the adhoc story file using the canonical story schema
    action:
      type: file_operation
      operation: create
      target: "!{story_file_target}"
      schema: "core/engineering/schemas/story.json"

  - id: ASSESS-DOCUMENT-IMPACT
    title: Assess impact on PRD and architecture documents
    description: Determine whether supporting docs need updates for this story
    action:
      type: elicit
      prompt_user: |
        Evaluate whether this story impacts PRD and/or architecture documents:
        1. No impact
        2. PRD impact only
        3. Architecture impact only
        4. Both PRD and Architecture impact

        Select the impact assessment (1-4).
      options: ["1", "2", "3", "4"]

  - id: UPDATE-DOCUMENTS
    title: Update affected documentation if needed
    description: Apply PRD/architecture updates based on the selected impact assessment
    action:
      type: analysis
      instruction: |
        If !{impact_assessment} == "1": record "No PRD/Architecture changes" in dev notes.
        Otherwise:
        - Update PRD sections for scope, requirements, or constraints changes.
        - Update Architecture docs when components, data models, APIs, or patterns change.
        - Summarize updates in the story dev_notes (doc_impact_summary).

  - id: HANDOFF-1
    title: Provide Summary and Next Steps
    description: Communicate story creation results and follow-ups
    action:
      type: hand_off
      prompt_user: |
        Story created: !{story_file_target}

        Checklist results: {{checklist_results}}

        Next steps:
        - Review the draft story and approve
        - Proceed to implementation when ready

completion:
  criteria:
    - Story YAML created in draft form
    - Story content aligned with epic and PRD
    - Checklist executed
    - Documentation impact assessed and updates recorded when needed
