$schema: ../../.internal/task.schema.json
id: create-story
title: Create Next Story Task
purpose: Identify the next logical story based on project progress and epic definitions, then prepare a comprehensive, self-contained story file ready for implementation
category: planning
agent: pdm

derived:
  - name: epic_resolved
    type: number
    source: parameters
    description: "Epic number provided via ${epic}."
    required: true
  - name: story_resolved
    type: number
    source: context
    description: "Story number to create. Uses ${story} when provided; otherwise determined from existing files."
    required: true
  - name: epic_file_path
    type: path
    source: context
    pattern: "@{docs.subdirs.epics}/{epic_resolved}-*.yaml"
    description: "Epic YAML file that defines the requirements for the story."
    required: true
  - name: story_file_target
    type: path
    source: context
    description: "Resolved output path for the new story file ({epic_resolved}.{story_resolved}-*.yaml)."
    required: true
  - name: previous_story_file
    type: path
    source: context
    description: "Highest numbered existing story file under @{docs.subdirs.stories} for the epic."
    required: false

outputs:
  artifacts:
    - name: Story File
      type: file
      path: "!{story_file_target}"
      format: yaml
  updates:
    - target: "!{story_file_target}"
      sections:
        - "Dev Notes"
        - "Tasks / Subtasks"
      restrictions: Only create new story files; do not modify existing stories

prerequisites:
  - field: "@{docs.subdirs.epics}"
    value: "readable"
    operator: "="
    on_violate: "halt_and_report"
  - field: "@{docs.subdirs.stories}"
    value: "writable"
    operator: "="
    on_violate: "halt_and_report"

steps:
  - id: CONFIG-1
    title: Load Core Configuration
    description: Load config.json and extract key configurations required for story creation
    action:
      type: file_operation
      operation: read
      target: "@{baseDir}/config.json"
      validation:
        type: string
        required: true
    on_failure: halt

  - id: VALIDATE-CONFIG
    title: Validate Required Configuration Entries
    description: Ensure docs, PRD, architecture, and workflow settings exist before proceeding
    action:
      type: validation
      instruction: |
        Extract and validate:
        - docs.subdirs.stories
        - docs.subdirs.epics
        - prd.* settings
        - architecture.* settings
        - workflow.* settings

        If any required configuration is missing, HALT with guidance to restore config.json from bmad-core or rerun the installer.

  - id: IDENTIFY-EPIC
    title: Locate Epic Files and Determine Next Story
    description: Locate the epic file and identify the next sequential story number (or use the supplied ${story})
    action:
      type: analysis
      instruction: |
        Based on configured PRD/epic locations:
        - Locate epic files (either dedicated epics path or sections in PRD).
        - If @{docs.subdirs.stories} already has files for epic !{epic_resolved}, load the highest `{epic}.{story}-*.yaml` to determine !{previous_story_file} and compute !{story_resolved}.
        - If ${story} is supplied, set !{story_resolved} accordingly.
        - Resolve !{story_file_target} for downstream steps.

  - id: HANDLE-EPIC-COMPLETE
    title: Handle Epic Completion Scenario
    description: Confirm next action when the current epic is complete
    action:
      type: elicit
      prompt_user: |
        Epic {{epic_number}} complete: all stories in epic {{epic_number}} are finished.

        Select an option:
        1) Begin epic {{next_epic_number}} with story 1
        2) Select a specific story to work on
        3) Cancel story creation

        CRITICAL: Never switch epics without explicit user instruction.
      options: ["1", "2", "3"]
      validation:
        type: string
        pattern: "^[1-3]$"
        required: true

  - id: GATHER-EPIC
    title: Gather Story Requirements from Epic
    description: Read the epic YAML to extract requirements for the story
    action:
      type: file_operation
      operation: read
      target: "!{epic_file_path}"
      instruction: |
        Extract:
        - Story title and description
        - Acceptance criteria
        - Priority
        - Dependencies

  - id: REVIEW-PREVIOUS
    title: Review Previous Story Context
    description: If a previous story exists, extract lessons learned and insights
    action:
      type: analysis
      target: "!{previous_story_file}"
      instruction: |
        Review Dev Agent Record sections for:
        - Completion notes and debug log references
        - Implementation deviations and technical decisions
        - Challenges encountered and lessons learned

        Capture any insights relevant to the new story.

  - id: ARCH-STRATEGY
    title: Determine Architecture Reading Strategy
    description: Select the architecture documents needed for this story
    action:
      type: decision
      instruction: |
        Determine which architecture documents to read based on story type:
        - Always read tech-stack, unified-project-structure, coding-standards, testing-strategy.
        - Backend/API stories: include data-models, database-schema, @{docs.files.beArchitecture}, rest-api-spec, external-apis.
        - Frontend/UI stories: include @{docs.files.feArchitecture}, components, core-workflows, UI data-models.
        - Full-stack: read both backend and frontend sections.

  - id: ARCH-READ
    title: Read Architecture Documents
    description: Load the selected architecture sections for reference
    action:
      type: file_operation
      operation: read
      target: "@{docs.dir}/?(*-)architecture.md"
      instruction: |
        Follow the reading strategy from ARCH-STRATEGY and load each required section before extracting technical details.

  - id: ARCH-EXTRACT
    title: Extract Story-Specific Technical Details
    description: Capture only the technical context required to implement the story
    action:
      type: analysis
      instruction: |
        Extract ONLY information directly relevant to the story:
        - Data models, schemas, or structures
        - API endpoints to implement or consume
        - Component specifications for UI elements
        - File paths and naming conventions for new code
        - Testing requirements and standards
        - Security or performance considerations

        Always cite the architecture source (e.g., [Source: architecture/<file>.md#{section}]). Do not invent details.

  - id: STRUCTURE-CHECK
    title: Verify Project Structure Alignment
    description: Cross-reference requirements with the project structure guide
    action:
      type: validation
      target: "@{docs.dir}/?(*-)architecture.md#unified-project-structure"
      instruction: |
        - Ensure file paths, component locations, and module names align with the unified structure.
        - Document any structural conflicts under "Project Structure Notes" in the story.

  - id: CREATE-STORY
    title: Create Story File
    description: Populate story schema with the extracted story data
    action:
      type: file_operation
      operation: create
      target: "!{story_file_target}"
      schema: "core/engineering/schemas/story.json"

  - id: RISK-ASSESS
    title: Assess Story Risk
    description: Evaluate risks specific to the story implementation
    action:
      type: analysis
      instruction: |
        Assess:
        - Impact on existing functionality
        - Technical complexity and unknowns
        - Integration challenges
        - Data migration or schema changes
        - Performance implications
        - Security considerations

        Document the primary risk, mitigation strategies, and rollback plan.

  - id: TASKS-GENERATE
    title: Generate Tasks and Subtasks
    description: Produce detailed technical tasks aligned with the story requirements
    action:
      type: analysis
      instruction: |
        Generate a sequential task list based ONLY on:
        - Epic requirements
        - Story acceptance criteria
        - Reviewed architecture information

        Each task must:
        - Reference the relevant architecture documentation
        - Include explicit unit-test subtasks
        - Assign Difficulty (1-10) reflecting complexity and uncertainty
        - Link to acceptance criteria where applicable (e.g., Task 1 (AC: 1, 3))

  - id: FINALIZE-STORY
    title: Review and Complete Story Draft
    description: Perform a final review and ensure the story is marked Draft
    action:
      type: validation
      instruction: |
        - Review all sections for completeness and accuracy
        - Verify every technical detail has a source reference
        - Ensure tasks align with epic requirements and architecture constraints
        - Confirm the story draft is saved and accessible

  - id: HANDOFF-SUMMARY
    title: Provide Summary and Next Steps
    description: Communicate story creation results to the user
    action:
      type: elicit
      prompt_user: |
        Story created: !{story_file_target}

        Key technical components included from architecture docs:
        {{component_summary}}

        Deviations or conflicts noted:
        {{conflicts}}

        Checklist results:
        {{checklist_results}}

        Next steps: Review the story draft (especially for complex stories) before handing off to development.

completion:
  checklist: story-draft-checklist
  criteria:
    - Story file created in draft form
    - All technical context extracted from architecture
    - Source references included for every technical detail
    - Tasks align with requirements and architecture constraints
    - Story-draft checklist executed successfully
