$schema: ../../.internal/task.schema.json
id: apply-qa-fixes
title: Apply QA Fixes
purpose: Apply fixes for a story based on QA review findings
category: quality
agent: dev

derived:
  - name: story_file
    type: path
    source: parameters
    pattern: "@{docs.subdirs.stories}/{story}-*.md"
    description: "Examples: 1.3, 2.5"
    required: true

outputs:
  updates:
    - target: "!{story_file}"
      sections:
        - "Tasks / Subtasks Checkboxes"
        - "Dev Agent Record"
      restrictions: Dev agent is ONLY authorized to update these sections

prerequisites:
  - field: "!{story_file}"
    value: "found"
    operator: "="
    on_violate: "halt_and_report"
  - field: "@{docs.subdirs.qa}/gates/${story}-*.json"
    value: "available"
    operator: "="
    on_violate: "continue_with_warning"

steps:
  - id: LOAD-CONFIG
    title: Load Core Config & Locate Story
    description: Read core config
    action:
      type: file_operation
      operation: read
      target: "@{baseDir}/config.json"
    on_failure: halt

  - id: READ-STORY
    title: Locate and Read Story File
    action:
      type: file_operation
      operation: read
      target: "!{story_file}"
    on_failure: halt

  - id: COLLECT-QA
    title: Collect QA Findings
    description: Parse gate JSON and read assessment markdowns
    action:
      type: analysis
      instruction: |
        Parse the latest gate JSON:
        - gate (PASS|CONCERNS|FAIL|WAIVED)
        - top_issues[] with id, severity, finding, suggested_action
        - nfr_validation.*.status and notes
        - trace coverage summary/gaps
        - test_design.coverage_gaps[]
        - risk_summary.recommendations.must_fix[] (if present)

        Read assessment markdowns and extract explicit gaps/recommendations

  - id: BUILD-FIX-PLAN
    title: Build Deterministic Fix Plan
    description: Create prioritized fix plan based on QA findings
    action:
      type: analysis
      instruction: |
        Apply in order, highest priority first:
        1. High severity items in top_issues (security/perf/reliability/maintainability)
        2. NFR statuses: all FAIL must be fixed â†’ then CONCERNS
        3. Test Design coverage_gaps (prioritize P0 scenarios if specified)
        4. Trace uncovered requirements (AC-level)
        5. Risk must_fix recommendations
        6. Medium severity issues, then low

        Guidance:
        - Prefer tests closing coverage gaps before/with code changes
        - Keep changes minimal and targeted; follow project architecture and TS/Deno rules

  - id: APPLY-CHANGES
    title: Apply Code and Test Changes
    description: Implement fixes according to the prioritized plan
    action:
      type: file_operation
      operation: update
      instruction: |
        - Implement code fixes per plan
        - Add missing tests to close coverage gaps (unit first; integration where required by AC)
        - Keep imports centralized via deps.ts
        - Follow DI boundaries in src/core/di.ts and existing patterns

  - id: VALIDATE-LINT
    title: Validate with Linting
    description: Run lint command and fix any issues
    action:
      type: command
      command: "{lint_command}"
    retry:
      max_attempts: 3
      delay_seconds: 1

  - id: VALIDATE-TESTS
    title: Validate with Tests
    description: Run all tests and ensure they pass
    action:
      type: command
      command: "{test_command}"
    retry:
      max_attempts: 3
      delay_seconds: 2

  - id: UPDATE-STORY
    title: Update Story File (Allowed Sections Only)
    description: Update only the sections Dev agent is authorized to modify
    action:
      type: file_operation
      operation: update
      target: "!{story_file}"
      instruction: |
        Update ONLY these sections:
        - Tasks / Subtasks Checkboxes (mark any fix subtask as done)
        - Dev Agent Record:
          - Debug Log References (commands/results, e.g., lint/tests)
          - Completion Notes List (what changed, why, how)
          - File List (all added/modified/deleted files)

  - id: COMPLETE
    title: Complete Fix Application
    description: Finalize the fix process - do not edit gate files
    action:
      type: validation
      instruction: |
        Dev does not modify gate JSON. If fixes address issues, request QA to re-run review-story to update the gate

completion:
  criteria:
    - "linting shows 0 problems"
    - "all test cases pass"
    - "All high severity top_issues addressed"
    - "NFR FAIL issues resolved; CONCERNS minimized or documented"
    - "Coverage gaps closed or explicitly documented with rationale"
    - "Story updated (allowed sections only) including File List"
  validations:
    - command: "{lint_command}"
      expected_output: "Checked.*files.*problems"
    - command: "{test_command}"
      expected_output: "ok.*passed"
