$schema: ../../.internal/task.schema.json
id: spec-outline-review
title: Spec Outline Review
purpose: Review a plain-English outline of test cases for clarity, completeness, coverage, and traceability (when a story is provided). Produce an immediate, actionable improvement report without creating files or requiring full test implementations.
category: quality
agent: qa

derived:
  - name: outline_text
    type: string
    source: parameters
    description: "Plain-English test outline input"
    required: true
  - name: story_path
    type: path
    source: parameters
    pattern: "@{docs.subdirs.stories}/{story}-*.yaml"
    description: "Optional story file path for traceability"
    required: false

prerequisites:
  - field: "!{outline_text}"
    value: ""
    operator: "!="
    on_violate: "halt_and_report"

steps:
  - id: LOAD-CONFIG
    title: Load Configuration
    description: Load core configuration for docs and path resolution.
    action:
      type: file_operation
      operation: read
      target: "@{baseDir}/config.json"
    on_failure: halt

  - id: NORMALIZE-OUTLINE
    title: Normalize Outline
    description: Normalize the provided outline into a structured list of scenarios suitable for analysis.
    action:
      type: analysis
      target: "outline_scenarios"
      instruction: |
        Normalize !{outline_text} by:
        - Extracting scenario titles and intents from describe/it statements or bullets
        - Removing code-specific syntax; keep human-readable expectations
        - Producing a numbered list of scenarios for downstream analysis

  - id: LOAD-STORY
    title: Load Story (Optional)
    description: Load the story file for AC traceability when provided.
    action:
      type: file_operation
      operation: read
      target: "!{story_path}"
    on_failure: continue

  - id: TRACEABILITY
    title: Traceability to Acceptance Criteria
    description: Map normalized scenarios to acceptance criteria when the story is available.
    action:
      type: analysis
      target: "traceability_notes"
      instruction: |
        For each normalized scenario:
        - If a story is loaded, identify the AC number(s) or requirement it validates
        - Mark "untraceable" if no AC/requirement can be linked
        - Summarize a coverage table scenario_id -> [ACs]
        If no story is available, document that traceability was skipped.

  - id: WRITE-SPECS
    title: Update Test Specs in Story (Optional)
    description: Write or refresh the story's Test Specs section using the normalized outline.
    action:
      type: file_operation
      operation: update
      target: "!{story_path}"
      instruction: |
        Update the "Test Specs" section as follows:
        - Under "Specifications", write a numbered list from the normalized outline with concise test-intent sentences.
        - Include AC references captured in traceability when available.
        - Under "Artifacts", append any provided test file paths; otherwise leave unchanged.
        - Do not modify other story sections.
    on_failure: continue

  - id: COVERAGE
    title: Coverage Assessment
    description: Check breadth of coverage across functional dimensions.
    action:
      type: analysis
      target: "coverage_notes"
      instruction: |
        Assess whether the outline includes:
        - Positive paths and happy flows
        - Negative/error cases and validation failures
        - Edge/boundary values
        - State transitions and lifecycle
        - Multi-step flows and integration seams
        - Concurrency/async considerations (where relevant)
        Output gaps grouped by dimension.

  - id: NFR-RELEVANCE
    title: Non-Functional Considerations
    description: Evaluate whether relevant NFR aspects are addressed.
    action:
      type: analysis
      target: "nfr_notes"
      instruction: |
        Check for NFR-focused outline items where appropriate:
        - Performance-critical paths
        - Security/authz/authn and input validation
        - Accessibility (a11y), i18n/l10n for UI
        - Observability/logging and data integrity
        Note missing or mis-scoped NFRs with risk context.

  - id: QUALITY
    title: Outline Quality and Testability
    description: Assess clarity and executability of the outline.
    action:
      type: analysis
      target: "quality_notes"
      instruction: |
        Validate outline quality:
        - Clear Given-When-Then intent (or equivalent) per scenario
        - Single intent per scenario where practical
        - Deterministic setup/teardown assumptions
        - Test data needs identified or referenced
        - Required mocks/stubs/fixtures noted
        - Overlap avoided between outline items

  - id: DEDUP-CONFLICTS
    title: Redundancies and Contradictions
    description: Identify duplicate, overlapping, or conflicting outline items.
    action:
      type: analysis
      target: "dedup_notes"
      instruction: |
        - List redundant scenarios and propose de-duplication
        - Flag contradictions and recommend a single reliable source of truth

  - id: PRIORITIZE-GAPS
    title: Prioritize Gaps by Risk
    description: Classify gaps using P0/P1/P2 and propose focused additions.
    action:
      type: analysis
      target: "gap_priorities"
      instruction: |
        - Classify gaps: P0 (security/revenue-critical), P1 (core flows), P2 (secondary)
        - For each P0 gap, provide 1â€“2 concise outline items to add
        - Recommend sequencing for remediation work

  - id: REPORT
    title: Produce Actionable Report
    description: Output a concise, structured report to the console only (no files).
    action:
      type: analysis
      target: "console_output"
      instruction: |
        Output numbered sections:
        1) What's working well
        2) Gaps (by dimension and risk)
        3) Ambiguities needing clarification
        4) Redundancies or conflicts
        5) Actionable next steps ordered by risk

outputs:
  updates:
    - target: "!{story_path}"
      sections:
        - "Test Specs"
      restrictions: "QA agent may edit only the 'Test Specs' field; do not modify other sections"

completion:
  criteria:
    - Outline normalized for downstream analysis
    - Traceability mapping captured when story provided
    - Coverage gaps across dimensions identified
    - Relevant NFR considerations evaluated
    - Outline quality, redundancy, and conflicts documented
    - Actionable console report delivered
