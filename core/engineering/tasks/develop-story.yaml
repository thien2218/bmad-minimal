$schema: ../../.internal/task.schema.json
id: develop-story
title: Develop Story Task
purpose: Implement a story end-to-end using an implementation-first workflow; execute tasks/subtasks sequentially, then validate and document results.
category: development
agent: dev

derived:
  - name: story_path_resolved
    type: path
    source: context
    pattern: "@{docs.subdirs.stories}/${story}-*.yaml"
    description: "Concrete story file path resolved from ${story}."
    required: true

outputs:
  updates:
    - target: "!{story_path_resolved}"
      sections:
        - "Tasks / Subtasks Checkboxes"
        - "Dev Agent Record"
        - "Dev Agent Record/Checkboxes"
        - "Dev Agent Record/Debug Log References"
        - "Dev Agent Record/Completion Notes List"
        - "File List"
        - "Agent Model Used"
      restrictions: Only toggle checkboxes and append to allowed sections; never rename or reorder tasks
  artifacts:
    - name: Test Files
      type: file
      path: "{project_root}/tests/**"
      format: text
      description: Tests written after implementation during validation
    - name: Implementation Files
      type: file
      path: "{project_root}/**"
      format: text
      description: Production code implementing the story

prerequisites:
  - field: "dev.blocking.unapproved_dependencies"
    value: "false"
    operator: "="
    on_violate: "halt_and_report"
  - field: "dev.blocking.ambiguous_requirements"
    value: "false"
    operator: "="
    on_violate: "halt_and_report"

steps:
  - id: GATHER-INPUTS
    title: Load Core Configuration and Inputs
    description: Load config.json and gather settings required for development
    action:
      type: file_operation
      operation: read
      target: "@{baseDir}/config.json"
      instruction: |
        Extract:
        - docs.subdirs.stories
        - qa.* settings
        - workflow.* settings
        Resolve !{story_path_resolved} using ${story}.

  - id: LOAD-STORY
    title: Load Story File
    description: Read the story file to access tasks, subtasks, and acceptance criteria
    action:
      type: file_operation
      operation: read
      target: "!{story_path_resolved}"

  - id: ADD-TASKS
    title: Add Tasks to Story
    description: Add listed task/subtask items into the story's Tasks / Subtasks section
    action:
      type: tool-call
      target: "!{story_path_resolved}#tasks"
      instruction: |
        - Add the listed items into the story's "Tasks / Subtasks" section
        - Append only; never rename or reorder existing tasks
        - Use the checkbox list format already used in the story

  - id: WRITE-TESTS
    title: Write Tests After Implementation
    description: Add unit/integration tests covering the implemented functionality
    action:
      type: file_operation
      operation: update
      instruction: |
        - Write deterministic tests aligned with acceptance criteria
        - Use mocks/stubs where appropriate
        - Record new test files in the File List

  - id: RUN-COMMANDS
    title: Execute Validations and Checks
    description: Run the test suite, lint checks, and any other provided commands
    action:
      type: command
      command: "{test_command} && {lint_command} && {other_commands}"
      instruction: |
        - Run tests, linting, and additional commands provided for this story
      retry:
        max_attempts: 3
        delay_seconds: 0

  - id: HANDLE-FAILURES
    title: Handle Validation Failures
    description: Address test failures and escalate when limits are reached
    action:
      type: decision
      instruction: |
        If validations fail (and failures are valid):
        - Fix issues and rerun RUN-COMMANDS (max 3 attempts)
        - After 3 failed attempts, pause execution and report blockers to the user for guidance

  - id: UPDATE-STORY
    title: Update Story Notes
    description: Update allowed Dev Agent Record sections and logs
    action:
      type: file_operation
      operation: update
      target: "!{story_path_resolved}"
      instruction: |
        - Append to Debug Log References with test commands/results
        - Document Completion Notes and File List entries
        - Summarize changes directly within Completion Notes

completion:
  checklist: story-dod-checklist
  criteria:
    - All tasks and subtasks marked complete
    - Tests written and passing
    - Validations/regression pass
    - File List and Dev Agent Record updated
