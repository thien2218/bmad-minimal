$schema: ../../.internal/task.schema.json
id: develop-story
title: Develop Story Task
version: 2.0.0
purpose: Implement a WIP story end-to-end using an implementation-first workflow; execute tasks/subtasks sequentially, then validate and document results.
category: development
agent: dev

derived:
  - name: story_path_resolved
    type: path
    source: context
    pattern: "@{docs.subdirs.stories}/${story}-*.yaml"
    description: "Concrete story file path resolved from ${story}."
    required: true
  - name: story_status
    type: string
    source: file
    description: "Status field read from the target story file."
    required: true

outputs:
  updates:
    - target: "!{story_path_resolved}"
      sections:
        - "Tasks / Subtasks Checkboxes"
        - "Dev Agent Record"
        - "Dev Agent Record/Checkboxes"
        - "Dev Agent Record/Debug Log References"
        - "Dev Agent Record/Completion Notes List"
        - "File List"
        - "Change Log"
        - "Status"
        - "Agent Model Used"
      restrictions: Only toggle checkboxes and append to allowed sections; never rename or reorder tasks
  artifacts:
    - name: Test Files
      type: file
      path: "{project_root}/tests/**"
      format: text
      description: Tests written after implementation during validation
    - name: Implementation Files
      type: file
      path: "{project_root}/**"
      format: text
      description: Production code implementing the story

prerequisites:
  - field: "!{story_status}"
    value: "WIP"
    operator: "="
    on_violate: "halt_and_report"
  - field: "dev.blocking.unapproved_dependencies"
    value: "false"
    operator: "="
    on_violate: "halt_and_report"
  - field: "dev.blocking.ambiguous_requirements"
    value: "false"
    operator: "="
    on_violate: "halt_and_report"

steps:
  - id: LOAD-CONFIG
    title: Load Core Configuration and Inputs
    description: Load config.json and gather settings required for development
    action:
      type: file_operation
      operation: read
      target: "@{baseDir}/config.json"
      template: |
        Extract:
        - docs.subdirs.stories
        - qa.* settings
        - workflow.* settings
        Resolve !{story_path_resolved} using ${story}.

  - id: LOAD-STORY
    title: Load Story File
    description: Read the story file to access tasks, subtasks, and acceptance criteria
    action:
      type: file_operation
      operation: read
      target: "!{story_path_resolved}"

  - id: VERIFY-STATUS
    title: Verify Story Status is WIP
    description: Halt if the story is not ready for development
    action:
      type: validation
      template: |
        If !{story_status} != "WIP": halt, report to the user, and request status correction before proceeding.
    on_failure: halt

  - id: SELECT-TASK
    title: Read First or Next Task
    description: Select the next incomplete task/subtask from the story
    action:
      type: analysis
      target: "!{story_path_resolved}#tasks-and-subtasks"
      template: |
        - Parse the "Tasks / Subtasks" list in order
        - Select the first incomplete task/subtask
        - Record the selection for implementation

  - id: IMPLEMENT-TASK
    title: Implement Task and Subtasks
    description: Write production code to satisfy the selected task and its acceptance criteria
    action:
      type: file_operation
      operation: update
      template: |
        - Implement only the current task/subtask scope
        - Update the File List with created/modified files (relative paths)
        - Document key decisions in Dev Agent Record/Completion Notes

  - id: CHECK-REMAINING
    title: Check for Remaining Tasks
    description: Determine if more tasks remain before moving to validation
    action:
      type: decision
      prompt_user: |
        Are there incomplete tasks/subtasks remaining? If yes, return to SELECT-TASK; otherwise continue to test creation.

  - id: WRITE-TESTS
    title: Write Tests After Implementation
    description: Add unit/integration tests covering the implemented functionality
    action:
      type: file_operation
      operation: update
      template: |
        - Write deterministic tests aligned with acceptance criteria
        - Use mocks/stubs where appropriate
        - Record new test files in the File List

  - id: RUN-TESTS
    title: Execute Validations
    description: Run the test suite and execute the story-dod checklist
    action:
      type: command
      command: "{test_command}"
      template: |
        - Run all relevant tests
        - Execute story-dod-checklist items after the command
      retry:
        max_attempts: 3
        delay_seconds: 0

  - id: HANDLE-FAILURES
    title: Handle Validation Failures
    description: Address failures or mark the story as blocked when limits are reached
    action:
      type: decision
      template: |
        If tests fail (and failures are valid):
        - Fix issues and rerun RUN-TESTS (max 3 attempts)
        - After 3 failed attempts, branch to BLOCK-STORY

  - id: UPDATE-STORY
    title: Mark Checkboxes and Update Story Metadata
    description: Update allowable sections in the story file after successful implementation
    action:
      type: file_operation
      operation: update
      target: "!{story_path_resolved}"
      template: |
        - Mark completed tasks/subtasks with [x] only (no renaming or reordering)
        - Append entries to Debug Log References, Completion Notes, File List, and Change Log
        - Update Status to "Review" when ready

  - id: BLOCK-STORY
    title: Handle Blocked Conditions
    description: Set the story status to Blocked when prerequisites cannot be satisfied
    action:
      type: file_operation
      operation: update
      target: "!{story_path_resolved}"
      template: |
        Set Status to "Blocked" if:
        - Unapproved dependencies are required
        - Requirements remain ambiguous
        - Three consecutive implementation/validation failures occur
        - Required configuration is missing
        - Regression failures persist

  - id: COMPLETE-STORY
    title: Complete Story Implementation
    description: Final validation and status update once all work is done
    action:
      type: validation
      template: |
        Declare implementation complete only when:
        - All tasks/subtasks are checked and have corresponding tests
        - Tests/regression pass
        - File List and Dev Agent Record are complete
        - story-dod-checklist executed successfully
        - Status is "Review" (or "Blocked" when applicable)

completion:
  checklist: story-dod-checklist
  criteria:
    - All tasks and subtasks marked complete
    - Tests written and passing
    - Validations/regression pass
    - File List and Dev Agent Record updated
    - Final status set appropriately (Review or Blocked)
