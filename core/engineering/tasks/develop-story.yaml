$schema: ../../.internal/task.schema.json
id: develop-story
title: Develop Story Task
purpose: Build the story with an implementation-first flow
category: development
agent: dev

derived:
  - name: story_path_resolved
    type: path
    source: context
    pattern: "@{docs.subdirs.stories}/${story}-*.yaml"
    description: "Concrete story file path resolved from ${story}."
    required: true
  - name: story_status
    type: string
    source: file
    description: "Status field read from the target story file."
    required: true

outputs:
  updates:
    - target: "!{story_path_resolved}"
      sections:
        - "Dev Agent Record"
      restrictions: DO NOT edit other story parts
  artifacts:
    - name: Test Files
      type: file
      path: "{project_root}/tests/**"
      format: text
      description: Tests written after implementation during validation
    - name: Implementation Files
      type: file
      path: "{project_root}/**"
      format: text
      description: Production code implementing the story

prerequisites:
  - field: "!{story_status}"
    value: "WIP"
    operator: "="
    on_violate: "halt_and_report"
  - field: "dev.blocking.unapproved_dependencies"
    value: "false"
    operator: "="
    on_violate: "halt_and_report"
  - field: "dev.blocking.ambiguous_requirements"
    value: "false"
    operator: "="
    on_violate: "halt_and_report"

steps:
  - id: GATHER-INPUTS
    title: Load Core Configuration and Inputs
    description: Load config.json and gather settings required for development
    action:
      type: file_operation
      operation: read
      target: "@{baseDir}/config.json"
      instruction: |
        Extract:
        - docs.subdirs.stories
        - qa.* settings
        - workflow.* settings
        Resolve !{story_path_resolved} using ${story}.

  - id: LOAD-STORY
    title: Load Story File
    description: Read the story file to access tasks, subtasks, and acceptance criteria
    action:
      type: file_operation
      operation: read
      target: "!{story_path_resolved}"

  - id: EXECUTE-TASKS
    title: Execute tasks of Story
    description: Implement tasks and subtasks listed in the story file
    action:
      type: tool_call
      target: "!{story_path_resolved}#tasks"
      instruction: |
        - Add the listed items into the story's `tasks` section to your todo list using tool call
        - Append only; never rename or reorder existing tasks
        - Ensure the final appended task is ALWAYS "Update the status to 'Review' and 'Dev Agent Record' section of the story file" after all other tasks are added
        - Implement each task/subtask sequentially

  - id: WRITE-TESTS
    title: Write Tests After Implementation
    description: Add unit/integration tests covering the implemented functionality
    action:
      type: file_operation
      operation: update
      instruction: |
        - Write deterministic tests aligned with acceptance criteria
        - Use mocks/stubs where appropriate
        - Record new test files in the File List

  - id: RUN-COMMANDS
    title: Execute Validations and Checks
    description: Run the test suite, lint checks, and any other provided commands
    action:
      type: command
      command: "{test_command} && {lint_command} && {other_commands}"
      instruction: |
        - Run tests, linting, and additional commands provided for this story
      retry:
        max_attempts: 3
        delay_seconds: 0

  - id: HANDLE-FAILURES
    title: Handle Validation Failures
    description: Address test failures and escalate when limits are reached
    action:
      type: decision
      instruction: |
        If validations fail (and failures are valid):
        - Fix issues and rerun RUN-COMMANDS (max 3 attempts)
        - After 3 failed attempts, pause execution and report blockers to the user for guidance

completion:
  checklist: story-dod-checklist
  criteria:
    - All tasks and subtasks marked complete
    - Tests written and passing
    - Validations/regression pass
    - File List and Dev Agent Record updated
