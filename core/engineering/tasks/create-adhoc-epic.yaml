$schema: ../../.internal/task.schema.json
id: create-adhoc-epic
title: Create Adhoc Epic
purpose: Create a single epic for out-of-scope enhancements
category: planning
agent: pdm

derived:
  - name: epic_enhancement_number_resolved
    type: number
    source: context
    description: "Use optional ${epic_enhancement_number}; otherwise detect the highest adhoc enhancement number and increment it."
    required: true
  - name: epic_file_candidate
    type: path
    source: context
    description: "Resolved target file path for the epic being created (adhoc-<number>-<slug>.yaml)."
    required: true
  - name: prd_file
    type: path
    source: context
    pattern: "@{docs.files.prd}"
    required: true
  - name: architecture_file
    type: path
    source: context
    pattern: "@{docs.files.architecture}"
    required: true
  - name: impact_assessment
    type: string
    source: context
    pattern: "^[1-4]$"
    description: "Response captured from Assess Document Impact step"

outputs:
  artifacts:
    - name: Epic File
      type: file
      path: "!{epic_file_candidate}"
      format: yaml
    - name: Documentation Updates
      type: file
      path: "@{docs.dir}/"
      format: markdown

prerequisites:
  - field: "@{docs.subdirs.epics}"
    value: "writable"
    operator: "="
    on_violate: "halt_and_report"

steps:
  - id: CONFIG-1
    title: Load Core Configuration
    description: Load config.json and verify docs paths
    action:
      type: file_operation
      operation: read
      target: "@{baseDir}/config.json"
    on_failure: halt

  - id: DISCOVER-1
    title: Detect Highest Enhancement Number
    description: Determine the highest enhancement number from existing adhoc epic files
    action:
      type: analysis
      instruction: |
        Inspect @{docs.subdirs.epics} for files named adhoc-*.yaml.
        If ${epic_enhancement_number} is supplied, set !{epic_enhancement_number_resolved} to that value.
        Otherwise compute the maximum enhancement number from the existing files and increment it to populate !{epic_enhancement_number_resolved}.
        Record the resolved number and the associated slug candidates so downstream steps can reference !{epic_file_candidate}.

  - id: VALIDATE-1
    title: Validate Epic Non-Existence or Confirm Overwrite
    description: Ensure we do not overwrite an existing epic unintentionally
    action:
      type: prompt_user
      template: |
        Check if epic file exists: !{epic_file_candidate}
        If it exists, choose:
        1) Skip (do not create)
        2) Overwrite (replace content)
        3) Create new variant with different slug
      options: ["1", "2", "3"]

  - id: READ-1
    title: Read PRD for Enhancement
    description: Read PRD for the detected enhancement
    action:
      type: file_operation
      operation: read
      target: "!{prd_file}"

  - id: READ-2
    title: Read Architecture for Enhancement
    description: Read Architecture doc for the detected enhancement
    action:
      type: file_operation
      operation: read
      target: "!{architecture_file}"

  - id: EXTRACT-1
    title: Extract Epic Inputs from PRD/Architecture
    description: Extract goal, description, DOD, scope boundaries, FR/NFR mappings, and initial story list
    action:
      type: analysis
      instruction: |
        From PRD (!{prd_file}):
        - Identify epic goal and high-level description.
        - Map Functional Requirements (FRs) and Non-Functional Requirements (NFRs) applicable to the enhancement.
        - Propose an initial 1–3 story list with brief goals and priorities (1–5).

        From Architecture (!{architecture_file}):
        - Capture integration points and compatibility constraints.
        - Gather boundaries for in-scope vs out-of-scope lists.

  - id: SANITY-1
    title: Confirm enhancement understanding with user
    description: Sanity-check the interpreted change description and resolve ambiguities before drafting the epic
    action:
      type: prompt_user
      template: |
        Summarize the enhancement goal, key constraints, and proposed scope based on the provided change description and extracted context.
        Confirm there are no misunderstandings or missing details:
        1) Summary matches intent — proceed
        2) Something is unclear or incorrect — provide clarifications
      options: ["1", "2"]

  - id: CREATE-1
    title: Create Epic YAML (schema-aligned)
    description: Initialize the epic file following core/engineering/templates/epic-tmpl.yaml sections
    action:
      type: file_operation
      operation: create
      target: "!{epic_file_candidate}"
      schema: "core/engineering/templates/epic-tmpl.yaml"

  - id: VALIDATE-2
    title: Validate Epic Completeness
    description: Ensure required sections are present and consistent
    action:
      type: validation
      instruction: |
        Confirm presence and basic completeness of:
        - epic-overview (goal, description, definition_of_done)
        - scope-boundaries (in-scope, out-of-scope)
        - requirements-mapping (FRs and NFRs)
        - story-breakdown (story-list and rationale)
        - dependencies

  - id: ASSESS-DOCUMENT-IMPACT
    title: Assess impact on PRD and architecture documents
    description: Evaluate if this epic requires updates to existing documentation
    action:
      type: prompt_user
      template: |
        Evaluate whether this epic impacts the PRD and/or architecture documents:

        1. No impact on PRD or Architecture
        2. PRD impact only
        3. Architecture impact only
        4. Both PRD and Architecture impact

        Select the impact assessment (1-4).
      options: ["1", "2", "3", "4"]

  - id: UPDATE-DOCUMENTS
    title: Update affected documentation if needed
    description: Update PRD and/or architecture documents based on impact assessment
    action:
      type: analysis
      instruction: |
        If !{impact_assessment} == "1", document that no documentation updates are required.
        Otherwise, update the affected documents:
        - PRD: revise relevant sections when scope, requirements, or constraints change.
        - Architecture: update affected files/sections when component responsibilities, data models, APIs, or patterns change.
        - Record a brief note in the epic YAML summarizing documentation updates.

  - id: HANDOFF-1
    title: Provide Summary
    description: Summarize created epic file and next steps
    action:
      type: report_user
      template: |
        Epic created: !{epic_file_candidate}
        Status: Draft
        Stories proposed: {{story_count}}

        Next: Review the story list and priorities, then proceed to story creation.

completion:
  criteria:
    - Epic file created with Status Draft
    - Sections present per epic schema
    - Story list proposed with priorities
    - Documentation impact is assessed and updates are made if needed
