$schema: ../../.internal/task.schema.json
id: create-adhoc-epic
title: Create Enhancement Epic from Brownfield Docs
version: 1.0.0
purpose: Create a single epic for the highest-order enhancement using PRD and Architecture docs in {@docs.subdirs.epics} as authoritative references. Output YAML strictly follows the epic schema.
category: planning
agent: pdm

inputs:
   required:
      - name: epic_description
        type: string
   optional:
      - name: epic_enhancement_number
        type: number

outputs:
   artifacts:
      - name: Epic File
        type: file
        path: "{@docs.subdirs.epics}/adhoc-{epic_enhancement_number}-*.yaml"
        format: yaml
      - name: Documentation Updates
        type: file
        path: "{@docs.dir}/"
        format: markdown

process:
   mode: sequential
   steps:
      - id: CONFIG-1
        title: Load Core Configuration
        description: Load config.json and verify docs paths
        action:
           type: file_operation
           operation: read
           target: "{@baseDir}/config.json"
           validation:
              type: string
              required: true
        on_failure: halt

      - id: DISCOVER-1
        title: Detect Highest Enhancement Number
        description: Determine the highest enhancement number from epics docs
        action:
           type: analysis
           content: |
              Inspect {@docs.subdirs.epics} for files:
              - adhoc-*.yaml
              Extract all enhancement numbers and compute the maximum value.
              If input epic_enhancement_number is provided, use it instead.

      - id: VALIDATE-1
        title: Validate Epic Non-Existence or Confirm Overwrite
        description: Ensure we do not overwrite an existing epic unintentionally
        action:
           type: validation
           prompt: |
              Check if epic file exists: {@docs.subdirs.epics}/adhoc-{epic_enhancement_number}-*.yaml
              If it exists, choose:
              1) Skip (do not create)
              2) Overwrite (replace content)
              3) Create new variant with different slug
        elicit: true

      - id: READ-1
        title: Read PRD for Enhancement
        description: Read PRD for the detected enhancement
        action:
           type: file_operation
           operation: read
           target: "{@docs.files.prd}"
           validation:
              type: string
              required: true

      - id: READ-2
        title: Read Architecture for Enhancement
        description: Read Architecture doc for the detected enhancement
        action:
           type: file_operation
           operation: read
           target: "{@docs.files.architecture}"
           validation:
              type: string
              required: true

      - id: EXTRACT-1
        title: Extract Epic Inputs from PRD/Architecture
        description: Extract goal, description, DOD, scope boundaries, FR/NFR mappings, and initial story list
        action:
           type: analysis
           content: |
              From PRD:
              - Identify epic goal and high-level description
              - Map Functional Requirements (FRs) and Non-Functional Requirements (NFRs) applicable to the enhancement
              - Propose initial 1–3 story list with brief goals and priorities (1–5)

              From Architecture:
              - Note key integration points and compatibility constraints
              - Gather boundaries to fill in-scope/out-of-scope

      - id: CREATE-1
        title: Create Epic YAML (schema-aligned)
        description: Initialize the epic file following core/engineering/schemas/epic.json sections
        action:
           type: file_operation
           operation: create
           target: "{@docs.subdirs.epics}/adhoc-{epic_enhancement_number}-{enhancement_name}.yaml"
           content: |
              status: Draft
              epic-overview:
                goal: "{epic_goal}"
                description: |
                  {epic_description}
                definition_of_done:
                  - "1: End-to-end functionality delivered per PRD"
                  - "2: Existing functionality compatibility maintained"
                  - "3: Performance/security expectations met"
                  - "4: Documentation updated appropriately"
              scope-boundaries:
                in-scope:
                  - "{in_scope_item_1}"
                  - "{in_scope_item_2}"
                out-of-scope:
                  - "{out_of_scope_item_1}"
                  - "{out_of_scope_item_2}"
              requirements-mapping:
                functional-requirements:
                  - "**{FR id}**: {FR summary} - {implementation_scope}"
                non-functional-requirements:
                  - "**{NFR id}**: {NFR summary} - {acceptance_threshold}"
              story-breakdown:
                story-list:
                  - "1: **{Story 1 title}** - {Story 1 goal} [Priority: {1-5}]"
                  - "2: **{Story 2 title}** - {Story 2 goal} [Priority: {1-5}]"
                story-sequencing-rationale: "{why_this_order}"
              dependencies:
                dependencies:
                  - "**{dep_type}**: {dep_description} - {dep_impact}"
                story-dependencies:
                  - "Story {story_id} depends on {prereq_story_id}: {reason}"

      - id: VALIDATE-2
        title: Validate Epic Completeness
        description: Ensure required sections are present and consistent
        action:
           type: validation
           content: |
              Confirm presence and basic completeness of:
              - epic-overview (goal, description, definition_of_done)
              - scope-boundaries (in-scope, out-of-scope)
              - requirements-mapping (FRs and NFRs)
              - story-breakdown (story-list and rationale)
              - dependencies

      - id: ASSESS-DOCUMENT-IMPACT
        title: Assess impact on PRD and architecture documents
        description: Evaluate if this epic requires updates to existing documentation
        action:
           type: elicit
           prompt: |
              Evaluate whether this epic has any impact on the PRD and/or architecture documents:

              PRD Impact:
              - Update relevant sections (scope, requirements, constraints) if behavior or requirements change

              Architecture Impact:
              - Update affected files/sections if component responsibilities, data models, APIs, or patterns are affected

              Options:
              1. No impact on PRD or Architecture
              2. PRD impact only
              3. Architecture impact only
              4. Both PRD and Architecture impact

              Select the impact assessment:
           options: ["1", "2", "3", "4"]
           validation:
              type: string
              pattern: "^[1-4]$"
              required: true

      - id: UPDATE-DOCUMENTS
        title: Update affected documentation if needed
        description: Update PRD and/or architecture documents based on impact assessment
        condition:
           if: "inputs.impact_assessment != '1'"
        action:
           type: analysis
           content: |
              Based on impact assessment, update the affected documents:

              - PRD: update relevant sections if behavior or requirements change
              - Architecture: update affected files/sections if patterns are affected
              - Record a brief note in the epic YAML summarizing documentation updates
              - Create change-log record if PRD/Architecture are impacted (update the Change Log tables)

      - id: HANDOFF-1
        title: Provide Summary
        description: Summarize created epic file and next steps
        action:
           type: elicit
           prompt: |
              Epic created: {@docs.subdirs.epics}/adhoc-{epic_enhancement_number}-*.yaml
              Status: Draft
              Stories proposed: {story_count}
              Next: Review story list and priorities, then proceed to story creation.

blocking_conditions:
   - condition: "PRD file for detected enhancement not found"
     message: "Missing PRD docs. Cannot derive epic."
     severity: critical

completion:
   criteria:
      - Epic file created with Status Draft
      - Sections present per epic schema
      - Story list proposed with priorities
      - Documentation impact is assessed and updates are made if needed
