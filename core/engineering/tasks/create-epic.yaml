$schema: ../../.internal/task.schema.json
id: create-epic
title: Create Epic Task
purpose: Create a single epic for an initiative listed in the PRD, aligned with architecture constraints and ready for downstream story creation
category: planning
agent: pdm

derived:
  - name: epic_number
    type: number
    source: parameters
    description: "Epic number requested via ${epic_number}."
    required: true
  - name: enhancement_name
    type: string
    source: parameters
    description: "Enhancement name provided via ${enhancement_name}."
    required: true
  - name: epic_file_target
    type: path
    source: context
    pattern: "@{docs.subdirs.epics}/{epic_number}-{enhancement_name}.yaml"
    description: "Path for the epic YAML to create/update."
    required: true

outputs:
  artifacts:
    - name: Epic Document
      type: file
      path: "!{epic_file_target}"
      format: yaml

prerequisites:
  - field: "@{docs.subdirs.epics}"
    value: "writable"
    operator: "="
    on_violate: "halt_and_report"

steps:
  - id: ANALYZE-PROJECT
    title: Project Analysis
    description: Gather essential information about the existing project before drafting the epic
    action:
      type: analysis
      instruction: |
        Analyze:
        - PRD epic list and goals (from @{docs.files.prd})
        - Initiative scope and requirements
        - Architecture constraints/dependencies (from @{docs.dir}/?(*-)architecture.md)
        - Success criteria and acceptance thresholds

  - id: VALIDATE-SCOPE
    title: Validate Enhancement Scope
    description: Ensure the enhancement is appropriate for a single epic
    action:
      type: validation
      instruction: |
        Confirm:
        - Enhancement appears in the PRD epic list
        - Scope aligns with PRD goals
        - Work can be completed within a reasonable number of stories
        - Dependencies and constraints are understood

        Halt and request PRD review if any check fails.
    on_failure: halt

  - id: CREATE-EPIC-FILE
    title: Create Epic File with Schema Structure
    description: Initialize the epic YAML using the canonical epic schema
    action:
      type: file_operation
      operation: create
      target: "!{epic_file_target}"
      schema: "core/engineering/schemas/epic.json"

  - id: ADD-EPIC-DESCRIPTION
    title: Add Epic Description
    description: Populate the epic-overview section with PRD/architecture context
    action:
      type: file_operation
      operation: update
      target: "!{epic_file_target}"

  - id: DEFINE-STORIES
    title: Define Stories
    description: Capture focused stories that complete the epic
    action:
      type: analysis
      instruction: |
        Define minimal number of focused stories (at least 2) with priorities (1-5, 1 = highest):
        - Follow the PRD story breakdown
        - Sequence by dependencies first, then priority
        - Ensure each story can complete within one sprint

  - id: ADD-STORIES
    title: Add Stories to Epic
    description: Update story-breakdown with the elicited stories and sequencing rationale
    action:
      type: file_operation
      operation: update
      target: "!{epic_file_target}"
      template: |
        story-breakdown:
          story-list:
            {{story_list_entries}}
          story-sequencing-rationale: |
            {{story_sequencing_rationale}}

  - id: ADD-SCOPE-BOUNDARIES
    title: Add Scope and Boundaries
    description: Document in-scope/out-of-scope elements for the epic
    action:
      type: file_operation
      operation: update
      target: "!{epic_file_target}"
      template: |
        scope-boundaries:
          in-scope:
            {{in_scope_items}}
          out-of-scope:
            {{out_scope_items}}

  - id: ADD-DOD
    title: Add Definition of Done
    description: Capture the epic's Definition of Done within epic-overview
    action:
      type: file_operation
      operation: update
      target: "!{epic_file_target}"
      template: |
        epic-overview:
          definition_of_done:
            - "1: All stories completed with acceptance criteria met"
            - "2: Epic goals from PRD achieved"
            - "3: Integration points working correctly"
            - "4: Documentation updated appropriately"
            - "5: Quality gates passed"

  - id: VALIDATE-EPIC
    title: Validate Epic Completeness
    description: Ensure the epic includes every required section
    action:
      type: validation
      instruction: |
        Confirm the epic includes:
        - Clear goal/description aligned with PRD
        - Stories supporting PRD objectives
        - Scope boundaries matching PRD definition
        - Definition of Done covering success criteria
        - Dependencies understood and documented

  - id: HANDOFF-EPIC
    title: Provide Epic Summary
    description: Communicate epic creation status and next steps
    action:
      type: hand_off
      prompt_user: |
        Epic created: !{epic_file_target}

        Review the epic for:
        - Goal and scope alignment with PRD
        - Story list coverage and sequencing
        - Scope boundaries and Definition of Done completeness

        Next steps:
        - Confirm priorities with stakeholders
        - Proceed to story creation once approved

completion:
  criteria:
    - Epic scope aligns with PRD epic definition
    - Stories support PRD goals and requirements
    - Dependencies and constraints are understood
    - Stories are sequenced logically for implementation
    - Acceptance criteria are clearly defined
