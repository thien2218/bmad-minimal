$schema: ../../.internal/task.schema.json
id: develop-story-test-first
title: Develop Story (Test-First)
purpose: "Follow a TDD workflow to implement a story: read specs, write failing tests, implement to green, then update the story record."
category: development
agent: dev

derived:
  - name: story_path_resolved
    type: path
    source: context
    pattern: "@{docs.subdirs.stories}/${story}-*.yaml"
    description: "Concrete path for the story under development."
    required: true

outputs:
  updates:
    - target: "!{story_path_resolved}"
      sections:
        - "Dev Agent Record"
        - "Dev Agent Record/Checkboxes"
        - "Dev Agent Record/Debug Log References"
        - "Dev Agent Record/Completion Notes List"
        - "File List"
      restrictions: Only toggle checkboxes and append to allowed sections; never edit other story parts
  artifacts:
    - name: Test Files
      type: file
      path: "{project_root}/tests/**"
      format: text
      description: Tests authored from story specs (written first)
    - name: Implementation Files
      type: file
      path: "{project_root}/**"
      format: text
      description: Production code implementing the story after tests are in place

prerequisites:
  - field: "dev.blocking.missing_specs"
    value: "false"
    operator: "="
    on_violate: "halt_and_report"

steps:
  - id: LOAD-CONFIG
    title: Load Core Configuration and Story
    description: Load config.json and resolve the story file
    action:
      type: file_operation
      operation: read
      target: "@{baseDir}/config.json"
      template: |
        Resolve !{story_path_resolved} via ${story}; then read the story file to access specs and metadata.

  - id: EXTRACT-SPECS
    title: Extract Test Specs
    description: Locate the story's test specs before writing tests
    action:
      type: analysis
      target: "!{story_path_resolved}#test-specs"
      template: |
        - Locate a section titled "Test Specs", "Specs", or "Test Cases"
        - If missing, halt and request the user to add specs or run *spec-outline-review/

  - id: WRITE-TESTS
    title: Author Tests From Specs (Red)
    description: Translate specs into runnable tests before implementation
    action:
      type: file_operation
      operation: update
      template: |
        - For each spec, write a failing test using Given/When/Then intent
        - Follow repository test structure and naming conventions
        - Add required fixtures/mocks; keep tests deterministic

  - id: RUN-RED
    title: Run Tests (Expect Failures)
    description: Confirm that the new tests fail before implementation
    action:
      type: command
      command: "{test_command}"
      template: "Expect failure; record results in Dev Agent Record/Debug Log References before proceeding."

  - id: IMPLEMENT
    title: Implement Minimal Code to Pass Tests (Green)
    description: Implement production code iteratively until tests pass
    action:
      type: file_operation
      operation: update
      template: |
        - Implement the minimum code to satisfy failing tests
        - Keep changes small; rerun tests after each iteration
        - Update File List with created/modified files

  - id: RUN-GREEN
    title: Run Tests to Green
    description: Execute the test suite until it passes
    action:
      type: command
      command: "{test_command}"
      retry:
        max_attempts: 3
        delay_seconds: 0

  - id: REFACTOR
    title: Refactor with Safety
    description: Perform optional refactors while keeping tests green
    action:
      type: analysis
      template: |
        - Identify small refactors (naming, duplication, extractions)
        - Run tests after each change to ensure they remain green

  - id: UPDATE-STORY
    title: Update Story and Notes
    description: Update allowed Dev Agent Record sections and logs
    action:
      type: file_operation
      operation: update
      target: "!{story_path_resolved}"
      template: |
        - Append to Debug Log References with test commands/results
        - Document Completion Notes and File List entries
        - Summarize changes directly within Completion Notes

completion:
  criteria:
    - Spec-derived tests added and passing
    - Minimal implementation complete with tests green
    - Dev Agent Record updated in allowed sections
