$schema: ../../.internal/task.schema.json
id: develop-story-test-first
title: Develop Story (Test-First)
purpose: "Follow a TDD workflow to implement a story: read specs, write failing tests, implement to green, then update the story record."
category: development
agent: dev

derived:
  - name: story_path_resolved
    type: path
    source: context
    pattern: "@{docs.subdirs.stories}/${story}-*.yaml"
    description: "Concrete path for the story under development."
    required: true
  - name: story_status
    type: string
    source: file
    description: "Status field read from the target story file."
    required: true

outputs:
  updates:
    - target: "!{story_path_resolved}"
      sections:
        - "Dev Agent Record"
      restrictions: DO NOT edit other story parts
  artifacts:
    - name: Test Files
      type: file
      path: "{project_root}/tests/**"
      format: text
      description: Tests authored from story specs (written first)
    - name: Implementation Files
      type: file
      path: "{project_root}/**"
      format: text
      description: Production code implementing the story after tests are in place

prerequisites:
  - field: "!{story_status}"
    value: "WIP"
    operator: "="
    on_violate: "halt_and_report"
  - field: "dev.blocking.missing_specs"
    value: "false"
    operator: "="
    on_violate: "halt_and_report"

steps:
  - id: GATHER-INPUTS
    title: Load Core Configuration and Story
    description: Load config.json and resolve the story file
    action:
      type: file_operation
      operation: read
      target: "@{baseDir}/config.json"
      instruction: |
        Resolve !{story_path_resolved} via ${story}; then read the story file to access specs and metadata.

  - id: EXTRACT-SPECS
    title: Extract Test Specs
    description: Locate the story's test specs before writing tests
    action:
      type: analysis
      target: "!{story_path_resolved}#test-specs"
      instruction: |
        - Locate a section titled "Test Specs", "Specs", or "Test Cases"
        - If missing, halt and request the user to add specs or run *spec-outline-review/

  - id: WRITE-TESTS
    title: Author Tests From Specs (Red)
    description: Translate specs into runnable tests before implementation
    action:
      type: file_operation
      operation: update
      instruction: |
        - For each spec, write a failing test using Given/When/Then intent
        - Follow repository test structure and naming conventions
        - Add required fixtures/mocks; keep tests deterministic

  - id: RUN-RED
    title: Run Tests (Expect Failures)
    description: Confirm that the new tests fail before implementation
    action:
      type: command
      command: "{test_command}"
      instruction: "Expect failure; record results in Dev Agent Record/Debug Log References before proceeding."

  - id: EXECUTE-TASKS
    title: Execute tasks of Story
    description: Implement tasks and subtasks listed in the story file
    action:
      type: tool-call
      target: "!{story_path_resolved}#tasks"
      instruction: |
        - Add the listed items into the story's `tasks` section to your todo list using tool call
        - Append only; never rename or reorder existing tasks
        - Ensure the final appended task is ALWAYS "Update the status to 'Review' and 'Dev Agent Record' section of the story file" after all other tasks are added
        - Implement each task/subtask sequentially to pass the tests

  - id: RUN-GREEN
    title: Run Tests to Green
    description: Execute the test suite until it passes
    action:
      type: command
      command: "{test_command}"
      retry:
        max_attempts: 3
        delay_seconds: 0

  - id: RUN-OTHER-COMMANDS
    title: Execute Lint and Additional Commands
    description: Run lint checks and any other provided commands
    action:
      type: command
      command: "{lint_command} && {other_commands}"
      instruction: |
        - Run linting and additional commands configured for this story
      retry:
        max_attempts: 3
        delay_seconds: 0

completion:
  checklist: story-dod-checklist
  criteria:
    - Spec-derived tests added and passing
    - Minimal implementation complete with tests green
    - Dev Agent Record updated in allowed sections
